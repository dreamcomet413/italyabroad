<%- if !params[:category].blank?
      @category = Category.find(params[:category])
    else
      @category = Category.find(:first,:conditions=>['LOWER(name = ?)','wine'])
    end %>
<%- @parent = Category.find(params[:parent] || "wine") -%>

<%- search_url ||= @category == @parent ? search_index_path(:id => @parent) : nested_categories_url(@parent, @category) -%>



<div class="block center" id="box_wine_search">
  <%# if params[:category] == "wine" || ~ /search/ %>
  <% if params[:parent] != "other-drinks" && params[:category] != "other-drinks" %>
    <h3>Wine Search</h3>
  <% else %>
    <h3>Other Drink Search</h3>
  <% end %>
  <% form_tag search_url, :method => :get do %>
      <%= hidden_field_tag :id,@category.name.downcase if !@category.nil? %>
      <table border="0">
        <tr>
          <td>Text:</td>
          <td><%= text_field_tag :text, params[:text], {:id => "search_text"} %></td>
        </tr>
        <% if params[:parent] != "other-drinks" %>
          <tr>
            <td style="color: #ff0000; font-size: 14px;">Mood:</td>
            <td>
              <%#= select_tag :mood, options_from_collection_for_select(Mood.all, 'id', 'name', :selected => params[:mood]) + content_tag(:option,'Any',:value=>""), :id => "search_price" %>
              <%= select_tag :mood, options_for_select([["Any",""]]+Mood.all.map{ |x| [x.name,x.id]}, :selected => params[:mood]), :id => "search_price" %>
            </td>
          </tr>
        <% end %>
        <tr>
          <td>Region:</td>
          <td><%= select_tag :region_id, options_for_select(@category.products.regions.inject([["Any", ""]]) {|rs, r| rs << [r.name, r.id]}, params[:region_id].to_i), :id => "search_region" if !@category.nil? %></td>
        </tr>
        <tr>
          <td>Grape:</td>
          <td><%= select_tag(:grape_id, options_for_select(@category.products.grapes.inject([["Any", ""]]) {|gs, g| gs << [g.name.include?("Avola") ? "Nero d' Avola": g.name, g.id]}, params[:grape_id].to_i), :id => "search_grape") if !@category.nil? %></td>
        </tr>
        <tr>
          <td>Colour:</td>
          <td><%= select_tag(:color, options_for_select(Product.colors(@category), params[:color]), :id => "search_color") unless Product.all.blank? %></td>
        </tr>

        <tr>
          <td>Producer:</td>
          <td><%= select_tag :producer_id, options_for_select(@category.products.producers.inject([["Any", ""]]) { |ps, p| ps << [p.name, p.id] }, params[:producer_id].to_i), :id => "search_producer_name" if !@category.nil?  %></td>
        </tr>
        <tr>
          <td colspan="2"></td>
        </tr>
        <tr>
          <td>Organic:</td>
          <% checked = (params[:organic] == 'organic') ? true : false %>
          <td><%= check_box_tag :organic, 'organic',checked  %></td>
        </tr>
        <tr>
          <td>Vegan:</td>
          <% checked = (params[:vegetarian] == 'vegetarian') ? true : false %>
          <td><%= check_box_tag :vegetarian, 'vegetarian', checked  %>
        </tr>
        <tr>
          <td colspan="2"></td>
        </tr>
        <tr>
          <td>Price:</td>
          <td>
            <%= select_tag :price, options_for_select(
                    [
                            ["Any Price", ""],
                            ["Less than #{number_to_currency(7,{:unit => "&pound;", :precision => 0})}".html_safe, "< 7"],
                            ["From #{number_to_currency(7,{:unit => "&pound;", :precision => 0})} to #{number_to_currency(11,{:unit => "&pound;", :precision => 0})}".html_safe, "BETWEEN 7 AND 11"],
                            ["From #{number_to_currency(11,{:unit => "&pound;", :precision => 0})} to #{number_to_currency(15,{:unit => "&pound;", :precision => 0})}".html_safe, "BETWEEN 11 AND 15"],
                            ["From #{number_to_currency(16,{:unit => "&pound;", :precision => 0})} to #{number_to_currency(20,{:unit => "&pound;", :precision => 0})}".html_safe, "BETWEEN 16 AND 20"],
                            ["More than #{number_to_currency(30,{:unit => "&pound;", :precision => 0})}".html_safe, "> 30"]
                    ], params[:price]), :id => "search_price" -%>
          </td>
        </tr>
        <tr>
          <td colspan="2"></td>
        </tr>
        <tr>
          <td></td>
          <td style="padding:0 0 0 17px;"><%= image_submit_tag "search.png" %></td>
        </tr>
      </table>
  <% end %>
</div>

